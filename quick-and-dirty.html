<!DOCTYPE html>

<!--
Copyright (c) 2018 Genome Research Ltd.

Author: Christopher Harrison <ch12@sanger.ac.uk>

This program is free software: you can redistribute it and/or modify it
under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
-->

<html>
  <head>
    <title>Human Genetics Programme Group Registry</title>

    <style>
      h2 { cursor: pointer; }
      div.detail { display: none; }
    </style>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>(function() {
      var api = (function(api_uri) {
        // API call wrapper
        var requests = 0;
        $(document)
          .ajaxStart(function() {
            if (requests == 0) $("*").css("cursor", "progress");
            requests++;
          })
          .ajaxComplete(function() {
            requests--;
            if (requests == 0) $("*").css("cursor", "default");
          });

        var error_handler = function(endpoint) {
          return function(xhr) {
            var error_json = xhr.responseJSON,
                error_text = "Could not make API call to " + endpoint;

            alert(error_text);
            console.error(error_text);
            console.error(error_json);
          };
        };

        return function(endpoint, callback) {
          var uri = api_uri + endpoint
          $.getJSON(uri).done(callback)
                        .fail(error_handler(endpoint));
        };

      // Change this parameter to set a different API server URI
      })("http://localhost:5000");

      var populate_groups = (function() {
        var group_html = function(group) {
          return "<li>" +
                   "<h2 id=\"" + group.value + "\">" + group.value + "</h2>" +
                   "<div class=\"detail\" id=\"" + group.value + "-detail\"></div>" +
                 "</li>";
        };

        var by_group = function(a, b) {
          // Sort by group name
          return a.value > b.value;
        };

        return function(node) {
          // Get groups from API and append them to the list
          api("/groups", function(data) {
            data.sort(by_group).forEach(function(group) {
              node.append($(group_html(group)));
            });
          });
        };
      })();

      var group_details = function(data, callback) {
        // Write group detail
        // TODO This is callback-style so we can do API requests for people...
        var list_of = function(things) {
          return "<ul>" + things.map(function(t) { return "<li>" + t + "</li>"; }).join("") + "</ul>";
        };

        var no_data = "<em>None found</em>",
            prelims = data.prelims.length ? list_of(data.prelims) : no_data;

        var get_person = function(person) { return person.value; };

        callback(
          "<dl>" +
            "<dt>Description</dt><dd>" + (data.description || no_data) + "</dd>" +
            "<dt>Active</dt><dd>" + (data.active ? "Yes" : "No") + "</dd>" +
            "<dt>Prelim IDs</dt><dd>" + prelims + "</dd>" +
            "<dt>Principal Investigator</dt><dd>" + get_person(data.pi) + "</dd>" +
            "<dt>Owners</dt><dd>" + list_of(data.owners.map(get_person)) + "</dd>" +
            "<dt>Members</dt><dd>" + list_of(data.members.map(get_person)) + "</dd>" +
          "</dl>"
        );
      };

      $(document).ready(function() {
        var groups_node = $("#groups");
        populate_groups(groups_node);
        groups_node.click(function(e) {
          var target = e.target;

          if (target.tagName == "H2") {
            var group = target.id,
                detail = $("#" + group + "-detail");

            if (detail.is(":visible")) {
              // Hide details if visible
              detail.hide()

            } else {
              // Reload and show details if invisible
              api("/groups/" + group, function(data) {
                detail.empty()
                group_details(data, function(html) {
                  detail.append($(html));
                  detail.show();
                });
              });
            }
          }
        });
      });
    })();</script>
  </head>

  <body>
    <h1>Human Genetics Programme Group Registry</h1>
    <ul id="groups"></ul>
  </body>
<html>
